name: 'install-docker'
description:  'Installs docker'
inputs:
    env_file:
        description: 'The path to the environment file'
        required: true
runs:
    using: 'composite'
    steps:
        - name: Install Docker
          shell: bash
          run: |
            source ${{ inputs.env_file }}
            # echo "Installing docker - version ${VER_DOCKER_MAX}..."
            # sudo apt-get update
            # sudo apt-get install ca-certificates curl
            # sudo install -m 0755 -d /etc/apt/keyrings
            # sudo curl -fsSL https://download.docker.com/linux/ubuntu/gpg -o /etc/apt/keyrings/docker.asc
            # sudo chmod a+r /etc/apt/keyrings/docker.asc

            # # Add the repository to Apt sources:
            # echo \
            #   "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.asc] https://download.docker.com/linux/ubuntu \
            #   $(. /etc/os-release && echo "${VER_DOCKER_MAX}") stable" | \
            #   sudo tee /etc/apt/sources.list.d/docker.list > /dev/null
            # sudo apt-get update

            # sudo apt-get install docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin

            echo "Running 'apt-get update' and 'apt-get upgrade'..."
            sudo apt-get update
            sudo apt-get upgrade

            # echo "Running curl -fsSL test.docker.com -o get-docker.sh && sh get-docker.sh"
            # curl -fsSL test.docker.com -o get-docker.sh && sh get-docker.sh
            echo "Installing Docker version $VER_DOCKER_MAX"
            sudo apt-get install docker-ce=$VER_DOCKER_MAX docker-ce-cli=$VER_DOCKER_MAX containerd.io
            
            echo "Setup docker group"
            sudo usermod -aG docker $USER 
            echo "Runnning hello-world"
            docker run hello-world 
            echo "Get Version"
            docker version

            ## Verify it works
            sudo docker run hello-world

            ## Make it sudo-less
            sudo usermod -aG docker $USER
            newgrp docker
            docker run hello-world